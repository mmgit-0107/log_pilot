services:
  # 1. Local LLM Service (The Brain)
  llm-service:
    image: ollama/ollama:latest
    container_name: log-pilot-llm
    ports:
      - "11434:11434"
    volumes:
      - ollama_data:/root/.ollama
    # Entrypoint script to pull model if missing
    entrypoint: /bin/sh
    command: -c "ollama serve & sleep 5 && ollama pull llama3 && wait"
    networks:
      - pilot-net

  # 1.5 Log Generator (Run-once initialization)
  log-generator:
    image: python:3.9-slim
    container_name: log-pilot-generator
    volumes:
      - ./scripts:/app/scripts
      - ./data/source:/app/data/source
    working_dir: /app
    # Generate 12 months (365 days) of logs
    command: python scripts/generate_logs.py --days 365 --count 10000 --output_dir data/source/landing_zone
    networks:
      - pilot-net

  # 2. Ingestion Worker (Data Plane)
  ingestion-worker:
    build:
      context: .
      dockerfile: services/ingestion-worker/Dockerfile
    container_name: log-pilot-ingestion
    volumes:
      - ./data/source:/app/data/source
      # Mount processed dir handling
      - ./data/source/processed:/app/data/source/processed
      - duckdb_data:/app/data/target
      - ./config:/app/config
    environment:
      - INGESTION_SOURCE=FILE
      - PYTHONUNBUFFERED=1
    depends_on:
      llm-service:
        condition: service_started
      log-generator:
        condition: service_completed_successfully
    networks:
      - pilot-net

  # 3. Pilot Orchestrator (Control Plane)
  pilot-orchestrator:
    build:
      context: .
      dockerfile: services/pilot_orchestrator/Dockerfile
    container_name: log-pilot-brain
    volumes:
      - duckdb_data:/app/data/target
      - ./config:/app/config
      - ./prompts:/app/prompts
    environment:
      - LOCAL_API_KEY=dummy
      - SHADOW_MODEL=shadow-gpt
    ports:
      - "8000:8000"
    depends_on:
      - llm-service
    networks:
      - pilot-net

  # 4. Frontend UI (Web Interface)
  frontend:
    build:
      context: ./services/frontend
      dockerfile: Dockerfile
    container_name: log-pilot-ui
    ports:
      - "3000:80"
    networks:
      - pilot-net

  # 5. MCP Server (Model Context Protocol)
  mcp-server:
    build:
      context: .
      dockerfile: services/mcp_server/Dockerfile
    container_name: log-pilot-mcp
    volumes:
      - duckdb_data:/app/data/target
      - ./config:/app/config
    ports:
      - "8001:8001"
    depends_on:
      - pilot-orchestrator
    networks:
      - pilot-net

  # 6. Evaluation Service (Ragas/Metrics)
  evaluation-service:
    build:
      context: .
      dockerfile: services/evaluation_service/Dockerfile
    container_name: log-pilot-eval
    volumes:
      - duckdb_data:/app/data/target
      - ./tests/evaluation:/app/tests/evaluation
    ports:
      - "8002:8001"
    environment:
      - LLM_BASE_URL=http://log-pilot-llm:11434/v1
      - PILOT_API_URL=http://pilot-orchestrator:8000
    depends_on:
      - llm-service
      - pilot-orchestrator
    networks:
      - pilot-net

volumes:
  ollama_data:
  duckdb_data:


networks:
  pilot-net:
    driver: bridge
